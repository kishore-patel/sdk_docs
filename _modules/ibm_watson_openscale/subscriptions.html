<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ibm_watson_openscale.subscriptions &mdash; IBM Watson OpenScale 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            IBM Watson OpenScale
          </a>
              <div class="version">
                1.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">IBM Watson OpenScale</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ibm_watson_openscale.subscriptions</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ibm_watson_openscale.subscriptions</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>

<span class="c1"># Copyright 2020,2021 IBM All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>


<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">ibm_cloud_sdk_core</span> <span class="kn">import</span> <span class="n">BaseService</span>
<span class="kn">from</span> <span class="nn">ibm_watson_openscale.base_classes.tables</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">ibm_watson_openscale.base_classes.watson_open_scale_v2</span> <span class="kn">import</span> <span class="n">Asset</span><span class="p">,</span> <span class="n">AssetPropertiesRequest</span><span class="p">,</span> \
    <span class="n">AssetDeploymentRequest</span><span class="p">,</span> <span class="n">RiskEvaluationStatus</span>
<span class="kn">from</span> <span class="nn">ibm_watson_openscale.base_classes.watson_open_scale_v2</span> <span class="kn">import</span> <span class="n">SparkStruct</span><span class="p">,</span> <span class="n">IntegratedSystems</span><span class="p">,</span><span class="n">IntegratedSystemsListEnums</span><span class="p">,</span><span class="n">AnalyticsEngine</span><span class="p">,</span><span class="n">JsonPatchOperation</span><span class="p">,</span> <span class="n">DataSourceStatus</span><span class="p">,</span> <span class="n">DataSource</span><span class="p">,</span> <span class="n">DataSourceConnection</span>
<span class="kn">from</span> <span class="nn">ibm_watson_openscale.base_classes.watson_open_scale_v2</span> <span class="kn">import</span> <span class="n">Subscriptions</span> <span class="k">as</span> <span class="n">BaseSubscriptions</span>
<span class="kn">from</span> <span class="nn">ibm_watson_openscale.base_classes.watson_open_scale_v2</span> <span class="kn">import</span> <span class="n">SchemaUtility</span>
<span class="kn">from</span> <span class="nn">ibm_watson_openscale.base_classes.watson_open_scale_v2</span> <span class="kn">import</span> <span class="n">ScoringEndpointRequest</span><span class="p">,</span> <span class="n">ScoringEndpointCredentialsAzureScoringEndpointCredentials</span>
<span class="kn">from</span> <span class="nn">ibm_watson_openscale.supporting_classes.enums</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ibm_watson_openscale.supporting_classes</span> <span class="kn">import</span> <span class="n">Target</span>

<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.client</span> <span class="kn">import</span> <span class="n">WatsonOpenScaleV2Adapter</span>
    <span class="kn">from</span> <span class="nn">ibm_watson_openscale.base_classes.watson_open_scale_v2</span> <span class="kn">import</span> <span class="n">DetailedResponse</span>

<span class="n">_DEFAULT_LIST_LENGTH</span> <span class="o">=</span> <span class="mi">50</span>


<span class="c1"># TODO: Add parameters validation in every method</span>
<div class="viewcode-block" id="Subscriptions"><a class="viewcode-back" href="../../index.html#ibm_watson_openscale.subscriptions.Subscriptions">[docs]</a><span class="k">class</span> <span class="nc">Subscriptions</span><span class="p">(</span><span class="n">BaseSubscriptions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages Subscription instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ai_client</span><span class="p">:</span> <span class="s1">&#39;WatsonOpenScaleV2Adapter&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">ai_client</span><span class="p">,</span> <span class="s1">&#39;ai_client&#39;</span><span class="p">,</span> <span class="n">BaseService</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span> <span class="o">=</span> <span class="n">ai_client</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">watson_open_scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="p">)</span>

<div class="viewcode-block" id="Subscriptions.show"><a class="viewcode-back" href="../../index.html#ibm_watson_openscale.subscriptions.Subscriptions.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
             <span class="n">data_mart_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">service_provider_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">asset_asset_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">deployment_deployment_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">deployment_deployment_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">integration_reference_integrated_system_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">integration_reference_external_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">risk_evaluation_status_state</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">service_provider_operational_space_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">pre_production_reference_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show service providers. By default 10 records will be shown.</span>

<span class="sd">        :param limit: maximal number of fetched rows. By default set to 10. (optional)</span>
<span class="sd">        :type limit: int</span>
<span class="sd">        :param str data_mart_id: (optional) comma-separeted list of IDs.</span>
<span class="sd">        :param str service_provider_id: (optional) comma-separeted list of IDs.</span>
<span class="sd">        :param str asset_asset_id: (optional) comma-separeted list of IDs.</span>
<span class="sd">        :param str deployment_deployment_id: (optional) comma-separeted list of</span>
<span class="sd">               IDs.</span>
<span class="sd">        :param str deployment_deployment_type: (optional) comma-separeted list of</span>
<span class="sd">               types.</span>
<span class="sd">        :param str integration_reference_integrated_system_id: (optional)</span>
<span class="sd">               comma-separeted list of IDs.</span>
<span class="sd">        :param str integration_reference_external_id: (optional) comma-separeted</span>
<span class="sd">               list of IDs.</span>
<span class="sd">        :param str risk_evaluation_status_state: (optional) comma-separeted list of</span>
<span class="sd">               states.</span>
<span class="sd">        :param str service_provider_operational_space_id: (optional)</span>
<span class="sd">               comma-separeted list of operational space ids (property of service provider</span>
<span class="sd">               object).</span>
<span class="sd">        :param str pre_production_reference_id: (optional) comma-separeted list of</span>
<span class="sd">               IDs.</span>
<span class="sd">        :param dict headers: A `dict` containing the request headers       </span>

<span class="sd">        A way you might use me is:</span>

<span class="sd">        &gt;&gt;&gt; client.subscriptions.show()</span>
<span class="sd">        &gt;&gt;&gt; client.subscriptions.show(limit=20)</span>
<span class="sd">        &gt;&gt;&gt; client.subscriptions.show(limit=None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">data_mart_id</span> <span class="o">=</span> <span class="n">data_mart_id</span><span class="p">,</span>
            <span class="n">service_provider_id</span> <span class="o">=</span> <span class="n">service_provider_id</span><span class="p">,</span>
            <span class="n">asset_asset_id</span> <span class="o">=</span> <span class="n">asset_asset_id</span><span class="p">,</span>
            <span class="n">deployment_deployment_id</span> <span class="o">=</span> <span class="n">deployment_deployment_id</span><span class="p">,</span>
            <span class="n">deployment_deployment_type</span> <span class="o">=</span> <span class="n">deployment_deployment_type</span><span class="p">,</span>
            <span class="n">integration_reference_integrated_system_id</span> <span class="o">=</span> <span class="n">integration_reference_integrated_system_id</span><span class="p">,</span>
            <span class="n">integration_reference_external_id</span> <span class="o">=</span> <span class="n">integration_reference_external_id</span><span class="p">,</span>
            <span class="n">risk_evaluation_status_state</span> <span class="o">=</span> <span class="n">risk_evaluation_status_state</span><span class="p">,</span>
            <span class="n">service_provider_operational_space_id</span> <span class="o">=</span> <span class="n">service_provider_operational_space_id</span><span class="p">,</span>
            <span class="n">pre_production_reference_id</span> <span class="o">=</span> <span class="n">pre_production_reference_id</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">records</span> <span class="o">=</span> <span class="p">[[</span><span class="n">subscription</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">asset_id</span><span class="p">,</span>
                    <span class="n">subscription</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">subscription</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">data_mart_id</span><span class="p">,</span>
                    <span class="n">subscription</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">deployment</span><span class="o">.</span><span class="n">deployment_id</span><span class="p">,</span>
                    <span class="n">subscription</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">deployment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">subscription</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">service_provider_id</span><span class="p">,</span>
                    <span class="n">subscription</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                    <span class="n">subscription</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
                    <span class="n">subscription</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">id</span>
                    <span class="p">]</span> <span class="k">for</span> <span class="n">subscription</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;asset_id&#39;</span><span class="p">,</span> <span class="s1">&#39;asset_name&#39;</span><span class="p">,</span> <span class="s1">&#39;data_mart_id&#39;</span><span class="p">,</span> <span class="s1">&#39;deployment_id&#39;</span><span class="p">,</span> <span class="s1">&#39;deployment_name&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;service_provider_id&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">]</span>

        <span class="n">Table</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
            <span class="n">default_limit</span><span class="o">=</span><span class="n">_DEFAULT_LIST_LENGTH</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Subscriptions&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Subscriptions.add"><a class="viewcode-back" href="../../index.html#ibm_watson_openscale.subscriptions.Subscriptions.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">data_mart_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">service_provider_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">asset</span><span class="p">:</span> <span class="s1">&#39;Asset&#39;</span><span class="p">,</span>
            <span class="n">deployment</span><span class="p">:</span> <span class="s1">&#39;AssetDeploymentRequest&#39;</span><span class="p">,</span>
            <span class="n">asset_properties</span><span class="p">:</span> <span class="s1">&#39;AssetPropertiesRequest&#39;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">risk_evaluation_status</span><span class="p">:</span> <span class="s1">&#39;RiskEvaluationStatus&#39;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">analytics_engine</span><span class="p">:</span> <span class="s1">&#39;AnalyticsEngine&#39;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">data_sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;DataSource&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">training_data_stats</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">background_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;DetailedResponse&#39;</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a subscription to the model deployment.</span>

<span class="sd">        :param str data_mart_id: ID of the data_mart (required)</span>
<span class="sd">        :param str service_provider_id: ID of the service_provider (required)</span>
<span class="sd">        :param Asset asset: an Asset object with asset&#39;s information (required)</span>
<span class="sd">        :param AssetDeploymentRequest deployment: an AssetDeploymentRequest object with deployment&#39;s information (required)</span>
<span class="sd">        :param AssetPropertiesRequest asset_properties: (optional) Additional asset</span>
<span class="sd">               properties (subject of discovery if not provided when creating the</span>
<span class="sd">               subscription).</span>
<span class="sd">        :param RiskEvaluationStatus risk_evaluation_status: (optional)</span>
<span class="sd">        :param AnalyticsEngine analytics_engine: (optional)</span>
<span class="sd">        :param List[DataSource] data_sources: (optional)</span>
<span class="sd">        :param training_data_stats: Training statistic json generated using training stats notebook (https://github.com/IBM-Watson/aios-data-distribution/blob/master/training_statistics_notebook.ipynb)</span>
<span class="sd">        :param background_mode: if set to True, run will be in asynchronous mode, if set to False</span>
<span class="sd">                it will wait for result (optional)</span>
<span class="sd">        :type background_mode: bool</span>
<span class="sd">        :return: A `DetailedResponse` containing the result, headers and HTTP status code.</span>
<span class="sd">        :rtype: DetailedResponse with `SubscriptionResponse` result</span>

<span class="sd">        A way you may use me:</span>

<span class="sd">        &gt;&gt;&gt; from ibm_watson_openscale import *</span>
<span class="sd">        &gt;&gt;&gt; added_subscription_info = client.subscriptions.add(</span>
<span class="sd">                data_mart_id=&#39;997b1474-00d2-4g05-ac02-287ebfc603b5&#39;,</span>
<span class="sd">                service_provider_id=&#39;997b1474-00d2-4g05-ac02-287ebfc603b5&#39;,</span>
<span class="sd">                asset=Asset(...),</span>
<span class="sd">                deployment=AssetDeploymentRequest(...),</span>
<span class="sd">                asset_properties=AssetPropertiesRequest(...),</span>
<span class="sd">             )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">data_mart_id</span><span class="p">,</span> <span class="s1">&#39;data_mart_id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">service_provider_id</span><span class="p">,</span> <span class="s1">&#39;service_provider_id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">check_entitlements</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">plan_name</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">LITE_PLAN</span><span class="p">:</span>
            <span class="n">total_subscriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">()</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">subscriptions</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_subscriptions</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You are not allowed to create more than 5 subscriptions for lite plan.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">asset_properties</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">training_data_stats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Either asset_properties or training_data_stats has to be passed&quot;</span><span class="p">)</span>
     
        <span class="c1">### If &quot;other&quot; data type is present in output or input schema then remove it from subscription before saving it.</span>
        <span class="c1">### https://github.ibm.com/aiopenscale/tracker/issues/19160</span>
        <span class="k">if</span> <span class="n">asset_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">asset_props</span> <span class="o">=</span> <span class="n">asset_properties</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;input_data_schema&#39;</span> <span class="ow">in</span> <span class="n">asset_props</span><span class="p">:</span>
                <span class="n">input_schema</span> <span class="o">=</span> <span class="n">asset_props</span><span class="p">[</span><span class="s1">&#39;input_data_schema&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">input_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">has_other_data_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_other_datatype</span><span class="p">(</span><span class="n">input_schema</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">has_other_data_type</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">asset_properties</span><span class="o">.</span><span class="n">input_data_schema</span> <span class="o">=</span> <span class="kc">None</span>    
            <span class="k">if</span> <span class="s1">&#39;output_data_schema&#39;</span> <span class="ow">in</span> <span class="n">asset_props</span><span class="p">:</span>    
                <span class="n">output_schema</span> <span class="o">=</span> <span class="n">asset_props</span><span class="p">[</span><span class="s1">&#39;output_data_schema&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">output_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">has_other_data_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_other_datatype</span><span class="p">(</span><span class="n">output_schema</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">has_other_data_type</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">asset_properties</span><span class="o">.</span><span class="n">output_data_schema</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;training_data_schema&#39;</span> <span class="ow">in</span> <span class="n">asset_props</span><span class="p">:</span>    
                <span class="n">training_schema</span> <span class="o">=</span> <span class="n">asset_props</span><span class="p">[</span><span class="s1">&#39;training_data_schema&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">training_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">has_other_data_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_other_datatype</span><span class="p">(</span><span class="n">training_schema</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">has_other_data_type</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">asset_properties</span><span class="o">.</span><span class="n">training_data_schema</span> <span class="o">=</span> <span class="kc">None</span> 
                        
        <span class="k">if</span> <span class="n">training_data_stats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">data_mart_id</span><span class="o">=</span><span class="n">data_mart_id</span><span class="p">,</span> <span class="n">service_provider_id</span><span class="o">=</span><span class="n">service_provider_id</span><span class="p">,</span> <span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">,</span>
                                   <span class="n">deployment</span><span class="o">=</span><span class="n">deployment</span><span class="p">,</span> <span class="n">asset_properties</span><span class="o">=</span><span class="n">asset_properties</span><span class="p">,</span>
                                   <span class="n">risk_evaluation_status</span><span class="o">=</span><span class="n">risk_evaluation_status</span><span class="p">,</span> 
                                   <span class="n">analytics_engine</span><span class="o">=</span><span class="n">analytics_engine</span><span class="p">,</span>
                                   <span class="n">data_sources</span><span class="o">=</span><span class="n">data_sources</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#Create subscription using data available in training stats</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">training_data_stats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;training_data_stats is empty. Please re-generate and use it&quot;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_subscription_from_training_stats</span><span class="p">(</span><span class="n">data_mart_id</span><span class="p">,</span> <span class="n">service_provider_id</span><span class="p">,</span> <span class="n">training_data_stats</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span><span class="n">background_mode</span> <span class="p">)</span>

        <span class="n">subscription_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__create_default_monitors</span><span class="p">(</span><span class="n">subscription_id</span><span class="p">,</span> <span class="n">data_mart_id</span><span class="p">,</span> <span class="n">service_provider_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">background_mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">check_state</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subscription_id</span><span class="o">=</span><span class="n">subscription_id</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">details</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">state</span>

            <span class="k">def</span> <span class="nf">get_result</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="s1">&#39;DetailedResponse&#39;</span><span class="p">]]:</span>
                <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subscription_id</span><span class="o">=</span><span class="n">subscription_id</span><span class="p">)</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">state</span>

                <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">StatusStateType</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="s2">&quot;Successfully finished adding subscription&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">details</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;Add subscription failed with status: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> \
                           <span class="s1">&#39;Reason: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="s2">&quot;code: </span><span class="si">{}</span><span class="s2">, message: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">message</span><span class="p">)</span> <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span>
                                                <span class="n">details</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">failure</span><span class="o">.</span><span class="n">errors</span><span class="p">]),</span> <span class="n">details</span>

            <span class="k">return</span> <span class="n">print_synchronous_run</span><span class="p">(</span>
                <span class="s1">&#39;Waiting for end of adding subscription </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subscription_id</span><span class="p">),</span>
                <span class="n">check_state</span><span class="p">,</span>
                <span class="n">get_result</span><span class="o">=</span><span class="n">get_result</span><span class="p">,</span>
                <span class="n">success_states</span><span class="o">=</span><span class="p">[</span><span class="n">StatusStateType</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">]</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Subscriptions.delete"><a class="viewcode-back" href="../../index.html#ibm_watson_openscale.subscriptions.Subscriptions.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">subscription_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">background_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="s1">&#39;DetailedResponse&#39;</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete subscription.</span>

<span class="sd">        :param str subscription_id: Unique subscription ID.</span>
<span class="sd">        :param bool force: (optional) force hard delete.</span>
<span class="sd">        :param background_mode: if set to True, run will be in asynchronous mode, if set to False</span>
<span class="sd">                it will wait for result (optional)</span>
<span class="sd">        :type background_mode: bool</span>
<span class="sd">        :return: A `DetailedResponse` containing the result, headers and HTTP status code.</span>
<span class="sd">        :rtype: DetailedResponse</span>

<span class="sd">        A way you may use me:</span>

<span class="sd">        &gt;&gt;&gt; client.subscriptions.delete(</span>
<span class="sd">                background_mode=False,</span>
<span class="sd">                subscription_id=&#39;997b1474-00d2-4g05-ac02-287ebfc603b5&#39;,</span>
<span class="sd">                force=True</span>
<span class="sd">             )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">subscription_id</span><span class="o">=</span><span class="n">subscription_id</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">background_mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">check_state</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">subscription_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">details</span><span class="o">.</span><span class="n">result</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">StatusStateType</span><span class="o">.</span><span class="n">FINISHED</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">StatusStateType</span><span class="o">.</span><span class="n">ACTIVE</span>

            <span class="k">def</span> <span class="nf">get_result</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="s1">&#39;DetailedResponse&#39;</span><span class="p">]]:</span>
                <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">subscription_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">details</span><span class="o">.</span><span class="n">result</span><span class="p">):</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">StatusStateType</span><span class="o">.</span><span class="n">FINISHED</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">StatusStateType</span><span class="o">.</span><span class="n">ACTIVE</span>

                <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">StatusStateType</span><span class="o">.</span><span class="n">FINISHED</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="s2">&quot;Successfully finished deleting subscription&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">response</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;Delete subscription failed&quot;</span><span class="p">,</span> <span class="s1">&#39;Reason: None&#39;</span><span class="p">,</span> <span class="n">response</span>  <span class="c1"># TODO: Need to show the reason.</span>

            <span class="k">return</span> <span class="n">print_synchronous_run</span><span class="p">(</span>
                <span class="s1">&#39;Waiting for end of deleting subscription </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subscription_id</span><span class="p">),</span>
                <span class="n">check_state</span><span class="p">,</span>
                <span class="n">get_result</span><span class="o">=</span><span class="n">get_result</span><span class="p">,</span>
                <span class="n">success_states</span><span class="o">=</span><span class="p">[</span><span class="n">StatusStateType</span><span class="o">.</span><span class="n">FINISHED</span><span class="p">]</span>
            <span class="p">)</span></div>
            
    <span class="k">def</span> <span class="nf">_has_other_datatype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;other&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>   
    
    <span class="c1">#Private method to create subscription using training stats data</span>
    <span class="k">def</span> <span class="nf">__create_subscription_from_training_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_mart_id</span><span class="p">,</span> <span class="n">service_provider_id</span><span class="p">,</span> <span class="n">training_stats_info</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span><span class="n">background_mode</span><span class="p">):</span>
        
        <span class="n">deployment_id</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deployment_id&quot;</span><span class="p">)</span>
        <span class="c1">#Required in case of headless subscription</span>
        <span class="n">deployment_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deployment_name&quot;</span><span class="p">)</span>
        <span class="n">deployment_space_id</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deployment_space_id&quot;</span><span class="p">)</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="n">training_stats_info</span><span class="p">[</span><span class="s1">&#39;common_configuration&#39;</span><span class="p">][</span><span class="s1">&#39;problem_type&#39;</span><span class="p">]</span>
        <span class="n">problem_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">model_type</span><span class="o">==</span><span class="s2">&quot;binary&quot;</span><span class="p">:</span>
            <span class="n">problem_type</span> <span class="o">=</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">BINARY_CLASSIFICATION</span>
        <span class="k">elif</span> <span class="n">model_type</span><span class="o">==</span><span class="s2">&quot;multiclass&quot;</span><span class="p">:</span>
            <span class="n">problem_type</span> <span class="o">=</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">MULTICLASS_CLASSIFICATION</span>
        <span class="k">elif</span> <span class="n">model_type</span><span class="o">==</span><span class="s2">&quot;regression&quot;</span><span class="p">:</span>
            <span class="n">problem_type</span> <span class="o">=</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">REGRESSION</span>    
        
        
        <span class="n">prediction_column</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prediction_field&quot;</span><span class="p">)</span>
        <span class="n">probability_columns</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;probability_fields&quot;</span><span class="p">)</span>
        <span class="n">predicted_target_column</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;predicted_target_field&quot;</span><span class="p">)</span>
        <span class="n">prediction_names</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prediction_names&quot;</span><span class="p">)</span>
        
        <span class="c1">#validate_type(deployment_id, &#39;deployment_id&#39;, str, True)</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">prediction_column</span><span class="p">,</span> <span class="s1">&#39;prediction_field&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1">#validate_type(predicted_target_column, &#39;predicted_target_field&#39;, str, True)</span>
        
        <span class="k">if</span> <span class="n">deployment_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deployment_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please provide deployment_id if you have deployment information or else provide deployment_name in case you want to create headless subscription&quot;</span><span class="p">)</span>
            
        <span class="n">model_asset_details_from_deployment</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">deployment_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">deployment_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deployment_space_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_asset_details_from_deployment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">service_providers</span><span class="o">.</span><span class="n">get_deployment_asset</span><span class="p">(</span><span class="n">data_mart_id</span><span class="o">=</span><span class="n">data_mart_id</span><span class="p">,</span><span class="n">service_provider_id</span><span class="o">=</span><span class="n">service_provider_id</span><span class="p">,</span><span class="n">deployment_id</span><span class="o">=</span><span class="n">deployment_id</span><span class="p">,</span><span class="n">deployment_space_id</span><span class="o">=</span><span class="n">deployment_space_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model_asset_details_from_deployment</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;guid&#39;</span><span class="p">]</span><span class="o">==</span> <span class="n">deployment_id</span><span class="p">:</span>
                <span class="n">deployment_found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">deployment_found</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Deployment with id </span><span class="si">{}</span><span class="s2"> could not be found in deployment space </span><span class="si">{}</span><span class="s2">. Please check again&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">,</span> <span class="n">deployment_space_id</span><span class="p">))</span>    
        <span class="k">elif</span> <span class="n">deployment_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deployment_space_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#For non-WML model, pick the right deployment from list</span>
            <span class="n">model_asset_details_from_deployment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">service_providers</span><span class="o">.</span><span class="n">list_assets</span><span class="p">(</span><span class="n">data_mart_id</span><span class="o">=</span><span class="n">data_mart_id</span><span class="p">,</span><span class="n">service_provider_id</span><span class="o">=</span><span class="n">service_provider_id</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>    
            <span class="n">models</span> <span class="o">=</span> <span class="n">model_asset_details_from_deployment</span><span class="p">[</span><span class="s1">&#39;resources&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;guid&#39;</span><span class="p">]</span><span class="o">==</span> <span class="n">deployment_id</span><span class="p">:</span>
                    <span class="n">model_asset_details_from_deployment</span> <span class="o">=</span> <span class="n">model</span>
                    <span class="n">deployment_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">deployment_found</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Deployment with id </span><span class="si">{}</span><span class="s2"> could not be found. Please check again&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">deployment_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deployment_space_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>     
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please provide deployment_id for space </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deployment_space_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating headless subscription as both deployment id and deployment space id are null&quot;</span><span class="p">)</span>              
            
        <span class="n">input_data_schema</span> <span class="o">=</span> <span class="n">training_stats_info</span><span class="p">[</span><span class="s2">&quot;common_configuration&quot;</span><span class="p">][</span><span class="s2">&quot;input_data_schema&quot;</span><span class="p">]</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">label_column</span><span class="o">=</span><span class="n">training_stats_info</span><span class="p">[</span><span class="s2">&quot;common_configuration&quot;</span><span class="p">][</span><span class="s2">&quot;label_column&quot;</span><span class="p">]</span>
        <span class="c1"># remove label column entry from input data schema</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">input_data_schema</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label_column</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        
        <span class="n">required_input_data_schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;struct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="n">fields</span>
        <span class="p">}</span>
        <span class="n">training_data_schema</span> <span class="o">=</span> <span class="kc">None</span>
          
        <span class="k">if</span> <span class="n">deployment_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">deployment_found</span><span class="p">:</span>
            <span class="n">model_asset_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>  
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">deployment_name</span>   
            <span class="n">model_url</span> <span class="o">=</span> <span class="s2">&quot;https://dummyModelUrl&quot;</span>
            <span class="n">deployment_asset_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span> 
            <span class="n">deployment_name</span> <span class="o">=</span> <span class="n">deployment_name</span> 
            <span class="n">scoring_endpoint</span> <span class="o">=</span> <span class="s2">&quot;https://dummyScoringUrl&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">deployment_found</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Deployment with id </span><span class="si">{}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">))</span>    
            <span class="n">model_asset_id</span> <span class="o">=</span> <span class="n">model_asset_details_from_deployment</span><span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">][</span><span class="s2">&quot;asset&quot;</span><span class="p">][</span><span class="s2">&quot;asset_id&quot;</span><span class="p">]</span> 
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_asset_details_from_deployment</span><span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">][</span><span class="s2">&quot;asset&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>   
            <span class="n">model_url</span> <span class="o">=</span> <span class="n">model_asset_details_from_deployment</span><span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">][</span><span class="s2">&quot;asset&quot;</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
            <span class="n">deployment_asset_id</span> <span class="o">=</span>  <span class="n">model_asset_details_from_deployment</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;guid&#39;</span><span class="p">]</span>
            <span class="n">deployment_name</span> <span class="o">=</span> <span class="n">model_asset_details_from_deployment</span><span class="p">[</span><span class="s1">&#39;entity&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">scoring_endpoint</span> <span class="o">=</span> <span class="n">model_asset_details_from_deployment</span><span class="p">[</span><span class="s1">&#39;entity&#39;</span><span class="p">][</span><span class="s1">&#39;scoring_endpoint&#39;</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">model_asset_details_from_deployment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_asset_details_from_deployment</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>     
            <span class="k">if</span> <span class="s2">&quot;training_data_schema&quot;</span> <span class="ow">in</span> <span class="n">model_asset_details_from_deployment</span><span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">][</span><span class="s2">&quot;asset_properties&quot;</span><span class="p">]:</span>
                <span class="n">training_data_schema</span> <span class="o">=</span> <span class="n">SparkStruct</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">model_asset_details_from_deployment</span><span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">][</span><span class="s2">&quot;asset_properties&quot;</span><span class="p">][</span><span class="s2">&quot;training_data_schema&quot;</span><span class="p">])</span>
            
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">data_mart_id</span><span class="o">=</span><span class="n">data_mart_id</span><span class="p">,</span>
                <span class="n">service_provider_id</span><span class="o">=</span><span class="n">service_provider_id</span><span class="p">,</span>
                <span class="n">asset</span><span class="o">=</span><span class="n">Asset</span><span class="p">(</span>
                    <span class="n">asset_id</span><span class="o">=</span><span class="n">model_asset_id</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">model_url</span><span class="p">,</span>
                    <span class="n">asset_type</span><span class="o">=</span><span class="n">AssetTypes</span><span class="o">.</span><span class="n">MODEL</span><span class="p">,</span>
                    <span class="n">input_data_type</span><span class="o">=</span><span class="n">InputDataType</span><span class="o">.</span><span class="n">STRUCTURED</span><span class="p">,</span>
                    <span class="n">problem_type</span><span class="o">=</span><span class="n">problem_type</span>
                <span class="p">),</span>
                <span class="n">deployment</span><span class="o">=</span><span class="n">AssetDeploymentRequest</span><span class="p">(</span>
                    <span class="n">deployment_id</span><span class="o">=</span><span class="n">deployment_asset_id</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">deployment_name</span><span class="p">,</span>
                    <span class="n">deployment_type</span><span class="o">=</span> <span class="n">DeploymentTypes</span><span class="o">.</span><span class="n">ONLINE</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">scoring_endpoint</span>
                <span class="p">),</span>
                <span class="n">asset_properties</span><span class="o">=</span><span class="n">AssetPropertiesRequest</span><span class="p">(</span>
                    <span class="n">label_column</span><span class="o">=</span><span class="n">label_column</span><span class="p">,</span>
                    <span class="n">probability_fields</span><span class="o">=</span><span class="n">probability_columns</span><span class="p">,</span>
                    <span class="n">prediction_field</span><span class="o">=</span><span class="n">prediction_column</span><span class="p">,</span>
                    <span class="n">predicted_target_field</span><span class="o">=</span><span class="n">predicted_target_column</span><span class="p">,</span>
                    <span class="n">prediction_names</span> <span class="o">=</span> <span class="n">prediction_names</span><span class="p">,</span>
                    <span class="n">feature_fields</span> <span class="o">=</span> <span class="n">training_stats_info</span><span class="p">[</span><span class="s2">&quot;common_configuration&quot;</span><span class="p">][</span><span class="s2">&quot;feature_fields&quot;</span><span class="p">],</span>
                    <span class="n">categorical_fields</span> <span class="o">=</span> <span class="n">training_stats_info</span><span class="p">[</span><span class="s2">&quot;common_configuration&quot;</span><span class="p">][</span><span class="s2">&quot;categorical_fields&quot;</span><span class="p">],</span>
                    <span class="n">input_data_schema</span> <span class="o">=</span> <span class="n">SparkStruct</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">required_input_data_schema</span><span class="p">),</span>
                    <span class="n">training_data_schema</span><span class="o">=</span><span class="n">training_data_schema</span>
                <span class="p">),</span>
                <span class="n">background_mode</span><span class="o">=</span><span class="n">background_mode</span>
            <span class="p">)</span>
        
<div class="viewcode-block" id="Subscriptions.create_feedback_table"><a class="viewcode-back" href="../../index.html#ibm_watson_openscale.subscriptions.Subscriptions.create_feedback_table">[docs]</a>    <span class="k">def</span> <span class="nf">create_feedback_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">subscription_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;DetailedResponse&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a table for feedback dataset type.</span>

<span class="sd">        :param str subscription_id: Unique subscription ID.</span>
<span class="sd">        :param dict headers: A `dict` containing the request headers</span>
<span class="sd">        :return: A `DetailedResponse` containing the result, headers and HTTP status code.</span>
<span class="sd">        :rtype: DetailedResponse with `DataSetResponse` result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataset_type</span> <span class="o">=</span> <span class="s2">&quot;feedback&quot;</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">(</span><span class="n">subscription_id</span><span class="o">=</span><span class="n">subscription_id</span><span class="p">,</span> <span class="n">dataset_type</span><span class="o">=</span><span class="n">dataset_type</span><span class="p">,</span> <span class="n">unknown_base_type</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subscriptions.poll_subscription_status"><a class="viewcode-back" href="../../index.html#ibm_watson_openscale.subscriptions.Subscriptions.poll_subscription_status">[docs]</a>    <span class="k">def</span> <span class="nf">poll_subscription_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
        <span class="n">subscription_status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">subscription_status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">):</span>
            <span class="n">subscriprion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subscription_id</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">subscription_status</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">subscriprion</span><span class="p">,</span> <span class="s2">&quot;entity.status.state&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">subscription_status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">),</span> <span class="n">subscription_status</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subscription_status</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">subscriprion</span><span class="p">,</span> <span class="s2">&quot;entity.status.failure&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">failure</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No failure information available&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">failure</span><span class="p">,</span> <span class="s2">&quot;trace&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trace: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">trace</span> <span class="k">else</span> <span class="n">trace</span><span class="p">))</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">failure</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">errors</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">error_code</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error code: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">error_code</span> <span class="k">else</span> <span class="n">error_code</span><span class="p">))</span>
                    <span class="n">error_message</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error message: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">error_message</span> <span class="k">else</span> <span class="n">error_message</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deleting subscription and related integrated systems ..&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__delete_integrated_sytems</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">subscription_id</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Subscription in error state !&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Subscriptions.create_subscription_using_training_data"><a class="viewcode-back" href="../../index.html#ibm_watson_openscale.subscriptions.Subscriptions.create_subscription_using_training_data">[docs]</a>    <span class="k">def</span> <span class="nf">create_subscription_using_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_name</span><span class="p">,</span> <span class="n">datamart_id</span><span class="p">,</span> <span class="n">service_provider_id</span><span class="p">,</span> <span class="n">model_info</span><span class="p">,</span> <span class="n">sample_csv</span><span class="p">,</span> <span class="n">spark_credentials</span><span class="p">,</span> <span class="n">data_warehouse_connection</span><span class="p">,</span> <span class="n">payload_table</span><span class="p">,</span> <span class="n">feedback_table</span><span class="p">,</span> <span class="n">scored_training_data_table</span><span class="p">,</span> <span class="n">managed_by</span><span class="p">,</span> <span class="n">background_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create batch subscription using model_info.</span>

<span class="sd">            :param str subscription_name: Name of this subscription.</span>
<span class="sd">            :param str datamart_id: Datamart id in which we want to to create this subscription.</span>
<span class="sd">            :param str service_provider_id: Service Provider id.</span>
<span class="sd">            :param dict model_info: Information about the model which needs the subscription.</span>
<span class="sd">                Format for model_info</span>
<span class="sd">                model_info = {</span>
<span class="sd">                    &quot;model_type&quot;: &quot;binary&quot;,</span>
<span class="sd">                    &quot;label_column&quot;: &quot;Risk&quot;,</span>
<span class="sd">                    &quot;prediction&quot;: &quot;predicted_label&quot;,</span>
<span class="sd">                    &quot;probability&quot;: &quot;probability&quot;,</span>
<span class="sd">                    &quot;feature_columns&quot;: [list of categorical columns]/None,</span>
<span class="sd">                    &quot;categorical_columns&quot;: [list of categorical columns]/None,</span>
<span class="sd">                    &quot;scoring&quot;: {</span>
<span class="sd">                        &quot;url&quot;: &quot;url&quot;:&quot;scoring url&quot;, # This is required if explainability needs to be enabled,</span>
<span class="sd">                        &quot;token&quot;: &quot;token for scoring&quot;, # This is mandatory for Azure ML studio Model</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            :param csv sample_csv: Sample csv file</span>
<span class="sd">            :param dict spark_credentials: Dictionary containing spark connection information.</span>
<span class="sd">                Format for spark_credentials</span>
<span class="sd">                spark_credentials = {</span>
<span class="sd">                    &quot;connection&quot;: {</span>
<span class="sd">                        &quot;endpoint&quot;: &lt;SPARK_ENDPOINT&gt;,</span>
<span class="sd">                        &quot;location_type&quot;: &lt;LOCATION_TYPE&gt;,</span>
<span class="sd">                        &quot;display_name&quot;: &lt;DISPLAY_NAME&gt;,</span>
<span class="sd">                        &quot;instance_id&quot;: &lt;INSTANCE_ID&gt;,</span>
<span class="sd">                        &quot;volume&quot;: &lt;VOLUME&gt;</span>
<span class="sd">                    },</span>
<span class="sd">                    &quot;credentials&quot;: {</span>
<span class="sd">                        &quot;username&quot;: &lt;USERNAME&gt;,</span>
<span class="sd">                        &quot;apikey&quot;: &lt;APIKEY&gt;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            :param dict data_warehouse_connection: Dictionary containing data warehouse (DB connection) information.</span>
<span class="sd">                Format for the DB connection</span>
<span class="sd">                dataware_house_connection = {</span>
<span class="sd">                    &quot;type&quot;: &quot;jdbc&quot;,</span>
<span class="sd">                    &quot;connection&quot;: {</span>
<span class="sd">                        &quot;jdbc_driver&quot;: &quot;com.ibm.db2.jcc.DB2Driver&quot;,</span>
<span class="sd">                        &quot;use_ssl&quot;: False,</span>
<span class="sd">                        &quot;certificate&quot;: None,</span>
<span class="sd">                        &quot;jdbc_url&quot;: &quot;jdbc:db2://&lt;HOST&gt;:50000/SAMPLE&quot;</span>
<span class="sd">                    },</span>
<span class="sd">                    &quot;credentials&quot;: {</span>
<span class="sd">                         &quot;username&quot;: &quot;&lt;USERNAME&gt;&quot;,</span>
<span class="sd">                        &quot;password&quot;: &quot;&lt;PASSWORD&gt;&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            :param dict payload_table: Dictionary containing payload table connection information.</span>
<span class="sd">                Format for the payload table</span>
<span class="sd">                payload_table = {</span>
<span class="sd">                    &quot;data&quot;: {</span>
<span class="sd">                        &quot;auto_create&quot;: True,</span>
<span class="sd">                        &quot;database&quot;: &quot;SAMPLE&quot;,</span>
<span class="sd">                        &quot;schema&quot;: &quot;KP&quot;,</span>
<span class="sd">                        &quot;table&quot;: &quot;PAYLOAD_TABLE&quot;</span>
<span class="sd">                    },</span>
<span class="sd">                    &quot;parameters&quot;:{</span>
<span class="sd">                        &quot;partition_column&quot;: &quot;WOS_PARTITION_COLUMN&quot;,</span>
<span class="sd">                        &quot;num_partitions&quot;: 12</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            :param dict feedback_table: Dictionary containing feedback table connection information.</span>
<span class="sd">            :param dict scored_training_data_table: Dictionary scored trainin data table.</span>
<span class="sd">                Format for scored_training_data_table</span>
<span class="sd">                scored_training_data_table = {</span>
<span class="sd">                    &quot;data&quot;: {</span>
<span class="sd">                        &quot;auto_create&quot;: False,</span>
<span class="sd">                        &quot;database&quot;: &quot;SAMPLE&quot;,</span>
<span class="sd">                        &quot;schema&quot;: &quot;KP&quot;,</span>
<span class="sd">                        &quot;table&quot;: &quot;SCORED_TRAINING_DATA_TABLE&quot;</span>
<span class="sd">                    },</span>
<span class="sd">                    &quot;parameters&quot;:{</span>
<span class="sd">                        &quot;partition_column&quot;: &quot;WOS_PARTITION_COLUMN&quot;,</span>
<span class="sd">                        &quot;num_partitions&quot;: 12</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            :param str managed_by: To identify whether the subscription is online or batch. It should be either `system` for online subscription or `self` for batch subscripion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">managed_by</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span><span class="p">):</span>
            <span class="n">validate_type</span><span class="p">(</span><span class="n">datamart_id</span><span class="p">,</span> <span class="s1">&#39;data_mart_id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">validate_type</span><span class="p">(</span><span class="n">service_provider_id</span><span class="p">,</span> <span class="s1">&#39;service_provider_id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">validate_type</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span> <span class="s1">&#39;model_info&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">validate_type</span><span class="p">(</span><span class="n">spark_credentials</span><span class="p">,</span> <span class="s1">&#39;spark_credentials&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">validate_type</span><span class="p">(</span><span class="n">payload_table</span><span class="p">,</span> <span class="s1">&#39;payload_table&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">validate_type</span><span class="p">(</span><span class="n">feedback_table</span><span class="p">,</span> <span class="s1">&#39;feedback_table&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">validate_type</span><span class="p">(</span><span class="n">scored_training_data_table</span><span class="p">,</span> <span class="s1">&#39;scored_training_data_table&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__validate_data_warehouse_connetion</span><span class="p">(</span><span class="n">data_warehouse_connection</span><span class="p">)</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">service_providers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">service_provider_id</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
            
            <span class="c1"># Take feature and catogerical field from user if provided.</span>
            <span class="n">user_feature_fields</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span><span class="s2">&quot;feature_columns&quot;</span><span class="p">)</span>
            <span class="n">user_categorical_field</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span><span class="s2">&quot;categorical_columns&quot;</span><span class="p">)</span>

            <span class="n">label_column</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span><span class="s2">&quot;label_column&quot;</span><span class="p">)</span>
            <span class="n">prediction_field</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
            <span class="n">probability_field</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span><span class="s2">&quot;probability&quot;</span><span class="p">)</span>
            <span class="n">transaction_id_field</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span><span class="s2">&quot;transaction_id_field&quot;</span><span class="p">)</span>
            <span class="n">prediction_names</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span><span class="s2">&quot;prediction_names&quot;</span><span class="p">)</span>

            <span class="n">feature_fields</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">categorical_fields</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Get feature fields if provided by user</span>
            <span class="n">isUserFeatureFields</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">user_feature_fields</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_feature_fields</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>

                <span class="c1"># Validate if prediction or probability field is added in feature columns&quot;</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">label_column</span> <span class="ow">in</span> <span class="n">user_feature_fields</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">prediction_field</span> <span class="ow">in</span> <span class="n">user_feature_fields</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">label_column</span> <span class="ow">in</span> <span class="n">user_feature_fields</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad Input: Prediction, probability or label column is/are added as feature column(s).&quot;</span><span class="p">)</span>

                <span class="n">feature_fields</span> <span class="o">=</span> <span class="n">user_feature_fields</span>
                <span class="n">isUserFeatureFields</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Get catogerical fields if provided by user</span>
            <span class="n">isUserCategoricalFields</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">user_categorical_field</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_categorical_field</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>

                <span class="c1"># Validate if prediction or probability field is added in categorical columns&quot;</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">label_column</span> <span class="ow">in</span> <span class="n">user_categorical_field</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">prediction_field</span> <span class="ow">in</span> <span class="n">user_categorical_field</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">label_column</span> <span class="ow">in</span> <span class="n">user_categorical_field</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad Input: Prediction, probability or label column is/are added as categorical column(s).&quot;</span><span class="p">)</span>

                <span class="c1"># Validate if categorical fields is subset of feature fields</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">isUserFeatureFields</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">user_categorical_field</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">user_feature_fields</span><span class="p">))))):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad Input: One or more categorical columns are not found in feature columns.&quot;</span><span class="p">)</span>

                <span class="n">categorical_fields</span> <span class="o">=</span> <span class="n">user_categorical_field</span>
                <span class="n">isUserCategoricalFields</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Validate scoring details provided by user</span>
            <span class="n">scoring</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span><span class="s2">&quot;scoring&quot;</span><span class="p">)</span>
            <span class="n">scoring_url</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">endpoint_credentials</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">service_providers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">service_provider_id</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
            <span class="k">if</span> <span class="n">provider</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">service_type</span> <span class="o">!=</span> <span class="n">ServiceTypes</span><span class="o">.</span><span class="n">CUSTOM_MACHINE_LEARNING</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">scoring</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[Error] Missing scoring details : scoring details are mandatory to create subscription&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">get</span><span class="p">(</span><span class="n">scoring</span><span class="p">,</span><span class="s2">&quot;url&quot;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[Error] Missing scoring url : scoring url is mandatory to create subscription&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">get</span><span class="p">(</span><span class="n">scoring</span><span class="p">,</span><span class="s2">&quot;token&quot;</span><span class="p">):</span>
                    <span class="n">endpoint_credentials</span> <span class="o">=</span> <span class="n">ScoringEndpointCredentialsAzureScoringEndpointCredentials</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">scoring</span><span class="p">,</span><span class="s2">&quot;token&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">provider</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">service_type</span> <span class="o">==</span> <span class="n">ServiceTypes</span><span class="o">.</span><span class="n">AZURE_MACHINE_LEARNING</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;[Error] Missing Token : Token is mandatory to create subscription for Azure ML studio model&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">scoring</span><span class="p">:</span>
                <span class="n">scoring_url</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">scoring</span><span class="p">,</span><span class="s2">&quot;url&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">scoring_url</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Warning] Missing scoring url : scoring url is mandatory if explain needs to be enabled&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Warning] Missing scoring details : scoring details are not provided&quot;</span><span class="p">)</span>

            <span class="c1"># Call config/datamart service API with CSV as payload to infer schema</span>
            <span class="n">schemaUtil</span> <span class="o">=</span> <span class="n">SchemaUtility</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="p">)</span>
            <span class="n">csv</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sample_csv</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">responseSchema</span> <span class="o">=</span> <span class="n">schemaUtil</span><span class="o">.</span><span class="n">spark_schemas_post</span><span class="p">(</span><span class="n">csv</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__validate_response_schema</span><span class="p">(</span><span class="n">responseSchema</span><span class="p">)</span>

            <span class="n">input_fields</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">output_fields</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">training_fields</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">fields</span> <span class="o">=</span> <span class="n">responseSchema</span><span class="o">.</span><span class="n">fields</span>
            <span class="n">field_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">field_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label_column</span><span class="p">):</span>
                    <span class="n">field</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;modeling_role&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span>
                    <span class="n">training_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">prediction_field</span><span class="p">):</span>
                    <span class="n">field</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;modeling_role&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;prediction&quot;</span>
                    <span class="n">output_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">probability_field</span><span class="p">)):</span>
                    <span class="n">field</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;modeling_role&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;feature&quot;</span>

                    <span class="c1"># If user provided feature columns</span>
                    <span class="k">if</span> <span class="n">isUserFeatureFields</span> <span class="ow">and</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">feature_fields</span><span class="p">:</span>
                        <span class="n">input_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                        <span class="n">output_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                        <span class="n">training_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                    <span class="k">elif</span><span class="p">(</span><span class="ow">not</span> <span class="n">isUserFeatureFields</span><span class="p">):</span>
                        <span class="n">feature_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                        <span class="n">input_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                        <span class="n">output_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                        <span class="n">training_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

                    <span class="c1"># If user provided categorical columns</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">isUserCategoricalFields</span> <span class="ow">and</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">categorical_fields</span><span class="p">):</span>
                        <span class="n">field</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;measure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;discrete&quot;</span>
                    <span class="k">elif</span><span class="p">(</span><span class="ow">not</span> <span class="n">isUserCategoricalFields</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">feature_fields</span> <span class="ow">and</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
                            <span class="n">categorical_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                            <span class="n">field</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;measure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;discrete&quot;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">isUserFeatureFields</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">user_feature_fields</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">field_names</span><span class="p">)))):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad Input: One or more feature field provided are not present in the input csv&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">isUserCategoricalFields</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">user_categorical_field</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">field_names</span><span class="p">)))):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bad Input: One or more catogerical field provided are not present in the input csv&quot;</span><span class="p">)</span>

            <span class="n">problem_type</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span><span class="s2">&quot;model_type&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">problem_type</span> <span class="o">!=</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">):</span>
                <span class="n">probability</span> <span class="o">=</span>  <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">probability_field</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;elementType&quot;</span><span class="p">:</span> <span class="s2">&quot;double&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;containsNull&quot;</span><span class="p">:</span> <span class="kc">True</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;nullable&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;modeling_role&quot;</span><span class="p">:</span> <span class="s2">&quot;probability&quot;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">output_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">probability</span><span class="p">)</span>

            <span class="n">spark_engine_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">db_integrated_system_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating integrated system for Spark&quot;</span><span class="p">)</span>
                <span class="n">spark_engine_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_spark_integrated_system</span><span class="p">(</span><span class="n">subscription_name</span><span class="p">,</span> <span class="n">spark_credentials</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating integrated system for Hive/DB2&quot;</span><span class="p">)</span>
                <span class="n">db_integrated_system_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_db2_hive_integrated_system</span><span class="p">(</span><span class="n">subscription_name</span><span class="p">,</span><span class="n">data_warehouse_connection</span><span class="p">)</span>

                <span class="c1"># Set asset details</span>
                <span class="n">asset</span> <span class="o">=</span> <span class="n">Asset</span><span class="p">(</span>
                    <span class="n">asset_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
                    <span class="n">url</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">subscription_name</span><span class="p">,</span>
                    <span class="n">asset_type</span><span class="o">=</span><span class="n">AssetTypes</span><span class="o">.</span><span class="n">MODEL</span><span class="p">,</span>
                    <span class="n">input_data_type</span><span class="o">=</span><span class="n">InputDataType</span><span class="o">.</span><span class="n">STRUCTURED</span><span class="p">,</span>
                    <span class="n">problem_type</span><span class="o">=</span><span class="n">problem_type</span>
                <span class="p">)</span>

                <span class="c1"># Set deployment details</span>
                <span class="n">asset_deployment</span> <span class="o">=</span> <span class="n">AssetDeploymentRequest</span><span class="p">(</span>
                    <span class="n">deployment_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">subscription_name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;This is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subscription_name</span><span class="p">),</span>
                    <span class="n">deployment_type</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span>
                    <span class="n">scoring_endpoint</span> <span class="o">=</span> <span class="n">ScoringEndpointRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">scoring_url</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">endpoint_credentials</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Define input, output and training data schema</span>
                <span class="n">input_data_schema</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fields&quot;</span> <span class="p">:</span> <span class="n">input_fields</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="n">responseSchema</span><span class="o">.</span><span class="n">type</span><span class="p">}</span>
                <span class="n">output_data_schema</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fields&quot;</span> <span class="p">:</span> <span class="n">output_fields</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="n">responseSchema</span><span class="o">.</span><span class="n">type</span><span class="p">}</span>
                <span class="n">training_data_scheme</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fields&quot;</span> <span class="p">:</span> <span class="n">training_fields</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="n">responseSchema</span><span class="o">.</span><span class="n">type</span><span class="p">}</span>

                <span class="n">asset_properties_request</span> <span class="o">=</span> <span class="n">AssetPropertiesRequest</span><span class="p">(</span>
                    <span class="n">transaction_id_field</span><span class="o">=</span><span class="n">transaction_id_field</span><span class="p">,</span>
                    <span class="n">label_column</span> <span class="o">=</span> <span class="n">label_column</span><span class="p">,</span>
                    <span class="n">probability_fields</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">probability_field</span> <span class="k">else</span> <span class="p">[</span><span class="n">probability_field</span><span class="p">],</span>
                    <span class="n">prediction_field</span> <span class="o">=</span> <span class="n">prediction_field</span><span class="p">,</span>
                    <span class="n">prediction_names</span> <span class="o">=</span> <span class="n">prediction_names</span><span class="p">,</span>
                    <span class="n">feature_fields</span> <span class="o">=</span> <span class="n">feature_fields</span><span class="p">,</span>
                    <span class="n">categorical_fields</span> <span class="o">=</span> <span class="n">categorical_fields</span>
                <span class="p">)</span>
                <span class="n">analytics_engine</span> <span class="o">=</span> <span class="n">AnalyticsEngine</span><span class="p">(</span>
                    <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;spark&quot;</span><span class="p">,</span>
                    <span class="n">integrated_system_id</span> <span class="o">=</span> <span class="n">spark_engine_id</span><span class="p">,</span>
                    <span class="n">parameters</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">spark_credentials</span><span class="p">,</span><span class="s2">&quot;spark_settings&quot;</span><span class="p">,{})</span>
                <span class="p">)</span>

                <span class="n">subscription_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="n">data_mart_id</span> <span class="o">=</span> <span class="n">datamart_id</span><span class="p">,</span>
                    <span class="n">service_provider_id</span> <span class="o">=</span> <span class="n">service_provider_id</span><span class="p">,</span>
                    <span class="n">asset</span> <span class="o">=</span> <span class="n">asset</span><span class="p">,</span>
                    <span class="n">deployment</span> <span class="o">=</span> <span class="n">asset_deployment</span><span class="p">,</span>
                    <span class="n">asset_properties</span> <span class="o">=</span> <span class="n">asset_properties_request</span><span class="p">,</span>
                    <span class="n">analytics_engine</span> <span class="o">=</span> <span class="n">analytics_engine</span><span class="p">,</span>
                    <span class="n">background_mode</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">result</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Delete all the integrated systems created for this failed subscription</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creation of subscription failed&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">spark_engine_id</span><span class="p">,</span> <span class="n">db_integrated_system_id</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__delete_integrated_sytems</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>

            <span class="n">subscription_id</span> <span class="o">=</span> <span class="n">subscription_details</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">id</span>
            <span class="n">schemas_patch_document</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">JsonPatchOperation</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">OperationTypes</span><span class="o">.</span><span class="n">REPLACE</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/asset_properties/training_data_schema&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">training_data_scheme</span><span class="p">),</span>
                    <span class="n">JsonPatchOperation</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">OperationTypes</span><span class="o">.</span><span class="n">REPLACE</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/asset_properties/input_data_schema&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">input_data_schema</span><span class="p">),</span>
                    <span class="n">JsonPatchOperation</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">OperationTypes</span><span class="o">.</span><span class="n">REPLACE</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/asset_properties/output_data_schema&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">output_data_schema</span><span class="p">)</span>
                <span class="p">]</span>

            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">spark_engine_id</span><span class="p">,</span> <span class="n">db_integrated_system_id</span><span class="p">]</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Updating schemas ...&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poll_subscription_status</span><span class="p">(</span><span class="n">subscription_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">subscription_id</span><span class="o">=</span><span class="n">subscription_id</span><span class="p">,</span> <span class="n">patch_document</span><span class="o">=</span><span class="n">schemas_patch_document</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Schemas update completed.&quot;</span><span class="p">)</span>

            <span class="c1"># Add selected tables as data sources</span>
            <span class="n">data_sources</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">source_type</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">data_warehouse_connection</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload_table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">get</span><span class="p">(</span><span class="n">payload_table</span><span class="p">,</span><span class="s2">&quot;data.table&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_data_source</span><span class="p">(</span><span class="n">payload_table</span><span class="p">,</span> <span class="n">db_integrated_system_id</span><span class="p">,</span> <span class="s2">&quot;payload&quot;</span><span class="p">,</span> <span class="n">source_type</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feedback_table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">get</span><span class="p">(</span><span class="n">feedback_table</span><span class="p">,</span><span class="s2">&quot;data.table&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_data_source</span><span class="p">(</span><span class="n">feedback_table</span><span class="p">,</span> <span class="n">db_integrated_system_id</span><span class="p">,</span> <span class="s2">&quot;feedback&quot;</span><span class="p">,</span> <span class="n">source_type</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scored_training_data_table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">get</span><span class="p">(</span><span class="n">scored_training_data_table</span><span class="p">,</span> <span class="s2">&quot;data.table&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scored_training_data_table</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;active&quot;</span>
                <span class="n">data_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_data_source</span><span class="p">(</span><span class="n">scored_training_data_table</span><span class="p">,</span> <span class="n">db_integrated_system_id</span><span class="p">,</span> <span class="s2">&quot;training&quot;</span><span class="p">,</span> <span class="n">source_type</span><span class="p">))</span>

            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Updating data-sources ...&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poll_subscription_status</span><span class="p">(</span><span class="n">subscription_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Patch datasources</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_sources</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data_sources_patch_document</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">JsonPatchOperation</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">OperationTypes</span><span class="o">.</span><span class="n">ADD</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/data_sources&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">data_sources</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">subscription_id</span><span class="o">=</span><span class="n">subscription_id</span><span class="p">,</span> <span class="n">patch_document</span><span class="o">=</span><span class="n">data_sources_patch_document</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data-sources update complete.&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Subscription is created. Id is : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subscription_id</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">background_mode</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Waiting for subscription to be in active state ...&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">poll_subscription_status</span><span class="p">(</span><span class="n">subscription_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Subscription is now in active state.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Subscription is being activated, please wait for state to be active before using it further.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">subscription_id</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">managed_by</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Currently not supporting online subscription&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The possible values for `managed_by` are either `system` for online subscription or `self` for batch subscripion&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Subscriptions.create_subscription"><a class="viewcode-back" href="../../index.html#ibm_watson_openscale.subscriptions.Subscriptions.create_subscription">[docs]</a>    <span class="k">def</span> <span class="nf">create_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">datamart_id</span><span class="p">,</span> <span class="n">service_provider_id</span><span class="p">,</span> <span class="n">configuration_archive</span><span class="p">,</span> <span class="n">spark_credentials</span><span class="p">,</span> <span class="n">data_warehouse_connection</span><span class="p">,</span> <span class="n">payload_table</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">feedback_table</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">,</span> <span class="n">model_info</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">background_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create batch subscription</span>
<span class="sd">            </span>
<span class="sd">            :param str subscription_name: Name of the subscription.</span>
<span class="sd">            :param str datamart_id: Datamart id in which we want to to create this subscription.</span>
<span class="sd">            :param str service_provider_id: Service Provider id.</span>
<span class="sd">            </span>
<span class="sd">            :param str configuration_archive: Path to the configuration archive file.</span>
<span class="sd">            :param dict spark_credentials: Dictionary containing spark connection information.</span>
<span class="sd">                Format for Remote Spark on hadoop </span>
<span class="sd">                spark_credentials =  {</span>
<span class="sd">                    &quot;connection&quot;:{</span>
<span class="sd">                        &quot;endpoint&quot;: &quot;&lt;SPARK_ENDPOINT&gt;&quot;,</span>
<span class="sd">                        &quot;location_type&quot;: &quot;custom&quot;</span>
<span class="sd">                    },</span>
<span class="sd">                    &quot;credentials&quot;: {</span>
<span class="sd">                        &quot;username&quot;: &quot;&lt;USERNAME&gt;&quot;,</span>
<span class="sd">                        &quot;password&quot;: &quot;&lt;PASSWORD&gt;&quot;</span>
<span class="sd">                    },</span>
<span class="sd">                    &quot;spark_settings&quot;: {</span>
<span class="sd">                        &quot;max_num_executors&quot;: &lt;MAX_EXECUTOR_COUNT&gt;,</span>
<span class="sd">                        &quot;min_num_executors&quot;: &lt;MIN_EXECUTOR_COUNT&gt;,</span>
<span class="sd">                        &quot;executor_cores&quot;: &lt;EXECUTOR_CORE&gt;,</span>
<span class="sd">                        &quot;executor_memory&quot;: &lt;EXECUTOR_MEMORY&gt;,</span>
<span class="sd">                        &quot;driver_cores&quot;: &lt;NUM_OF_DRIVER_CORES&gt;,</span>
<span class="sd">                        &quot;driver_memory&quot;: &lt;DRIVER_MEMORY&gt;</span>
<span class="sd">                    }                    </span>
<span class="sd">                }</span>
<span class="sd">                Format for IAE Spark</span>
<span class="sd">                spark_credentials = {</span>
<span class="sd">                &quot;connection&quot;: {</span>
<span class="sd">                    &quot;display_name&quot;: &quot;&lt;IAE_INSTANCE_DISPLAYNAME&gt;&quot;,</span>
<span class="sd">                    &quot;endpoint&quot;: &quot;&lt;IAE_JOB_ENDPOINT&gt;&quot;,</span>
<span class="sd">                    &quot;location_type&quot;: &quot;cpd_iae&quot;,</span>
<span class="sd">                    &quot;volume&quot;: &quot;&lt;VOLUME_NAME&gt;&quot;</span>
<span class="sd">                },</span>
<span class="sd">                &quot;credentials&quot;: {</span>
<span class="sd">                    &quot;username&quot;: &quot;&lt;USERNAME&gt;&quot;,</span>
<span class="sd">                    &quot;apikey&quot;: &quot;&lt;APIKEY&gt;&quot;</span>
<span class="sd">                },</span>
<span class="sd">                &quot;spark_setting&quot;: {</span>
<span class="sd">                    #Look at remote spark settings</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">            :param dict data_warehouse_connection: Dictionary containing data warehouse (DB connection) information.  </span>
<span class="sd">                Format for the DB connection</span>
<span class="sd">                dataware_house_connection = {</span>
<span class="sd">                    &quot;type&quot;: &quot;jdbc&quot;,</span>
<span class="sd">                    &quot;connection&quot;: {</span>
<span class="sd">                        &quot;jdbc_driver&quot;: &quot;com.ibm.db2.jcc.DB2Driver&quot;,</span>
<span class="sd">                        &quot;use_ssl&quot;: False,</span>
<span class="sd">                        &quot;certificate&quot;: None,</span>
<span class="sd">                        &quot;jdbc_url&quot;: &quot;jdbc:db2://&lt;HOST&gt;:50000/SAMPLE&quot;        </span>
<span class="sd">                    },</span>
<span class="sd">                    &quot;credentials&quot;: {</span>
<span class="sd">                         &quot;username&quot;: &quot;&lt;USERNAME&gt;&quot;,</span>
<span class="sd">                        &quot;password&quot;: &quot;&lt;PASSWORD&gt;&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">                </span>
<span class="sd">            :param dict payload_table: Dictionary containing payload table connection information.</span>
<span class="sd">                Format for the payload table </span>
<span class="sd">                payload_table = {</span>
<span class="sd">                    &quot;data&quot;: {</span>
<span class="sd">                        &quot;auto_create&quot;: True,</span>
<span class="sd">                        &quot;database&quot;: &quot;SAMPLE&quot;,</span>
<span class="sd">                        &quot;schema&quot;: &quot;KP&quot;,</span>
<span class="sd">                        &quot;table&quot;: &quot;PAYLOAD_GERMAN_CREDIT_DATA_NEW&quot;</span>
<span class="sd">                    },</span>
<span class="sd">                    &quot;parameters&quot;:{</span>
<span class="sd">                        &quot;partition_column&quot;: &quot;WOS_PARTITION_COLUMN&quot;,</span>
<span class="sd">                        &quot;num_partitions&quot;: 12</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            :param dict feedback_table: Dictionary containing feedback table connection information.</span>
<span class="sd">                Format for the feedback_table is same as payload table</span>
<span class="sd">            :param dict model_info: Information about the model which needs the subscription.</span>
<span class="sd">                Format for model_info</span>
<span class="sd">                model_info = {</span>
<span class="sd">                    &quot;model_type&quot;: &quot;binary&quot;,</span>
<span class="sd">                    &quot;label_column&quot;: &quot;Risk&quot;,</span>
<span class="sd">                    &quot;prediction&quot;: &quot;predicted_label&quot;,</span>
<span class="sd">                    &quot;probability&quot;: &quot;probability&quot;,</span>
<span class="sd">                    &quot;feature_columns&quot;: [list of categorical columns]/None,</span>
<span class="sd">                    &quot;categorical_columns&quot;: [list of categorical columns]/None,</span>
<span class="sd">                    &quot;scoring&quot;: {</span>
<span class="sd">                        &quot;url&quot;: &quot;url&quot;:&quot;scoring url&quot;, # This is required if explainability needs to be enabled,</span>
<span class="sd">                        &quot;token&quot;: &quot;token for scoring&quot;, # This is mandatory for Azure ML studio Model</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            :return: subscription id</span>
<span class="sd">            :rtype: str</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>    
        
        <span class="n">validate_type</span><span class="p">(</span><span class="n">subscription_name</span><span class="p">,</span> <span class="s1">&#39;subscription_name&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">datamart_id</span><span class="p">,</span> <span class="s1">&#39;data_mart_id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">service_provider_id</span><span class="p">,</span> <span class="s1">&#39;service_provider_id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1">#validate_type(configuration_archive, &#39;configuration_archive&#39;, str, True)</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">spark_credentials</span><span class="p">,</span> <span class="s1">&#39;spark_credentials&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">data_warehouse_connection</span><span class="p">,</span> <span class="s1">&#39;data_warehouse_connection&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">payload_table</span><span class="p">,</span> <span class="s1">&#39;payload_table&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">feedback_table</span><span class="p">,</span> <span class="s1">&#39;feedback_table&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span> <span class="s1">&#39;model_info&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__validate_data_warehouse_connetion</span><span class="p">(</span><span class="n">data_warehouse_connection</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__validate_table_info</span><span class="p">(</span><span class="n">payload_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">feedback_table</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">feedback_table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__validate_table_info</span><span class="p">(</span><span class="n">feedback_table</span><span class="p">)</span>

        <span class="n">scoring_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">endpoint_credentials</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">scoring</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span><span class="s2">&quot;scoring&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scoring</span><span class="p">:</span>
            <span class="n">scoring_url</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">scoring</span><span class="p">,</span><span class="s2">&quot;url&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">scoring_url</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Warning] Missing scoring url : There is no scoring url provided&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">get</span><span class="p">(</span><span class="n">scoring</span><span class="p">,</span><span class="s2">&quot;token&quot;</span><span class="p">):</span>
                <span class="n">endpoint_credentials</span> <span class="o">=</span> <span class="n">ScoringEndpointCredentialsAzureScoringEndpointCredentials</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">scoring</span><span class="p">,</span><span class="s2">&quot;token&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">service_providers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">service_provider_id</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
                <span class="k">if</span> <span class="n">provider</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">service_type</span> <span class="o">==</span> <span class="n">ServiceTypes</span><span class="o">.</span><span class="n">AZURE_MACHINE_LEARNING</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Warning] Missing Token : There is no token provided for Azure ML studio model&quot;</span><span class="p">)</span>

        <span class="c1">#TODO validate parameters</span>
        <span class="n">spark_engine_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">db_integrated_system_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating integrated system for Spark&quot;</span><span class="p">)</span>
            <span class="n">spark_engine_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_spark_integrated_system</span><span class="p">(</span><span class="n">subscription_name</span><span class="p">,</span> <span class="n">spark_credentials</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating integrated system for Hive/DB2&quot;</span><span class="p">)</span>            
            <span class="n">db_integrated_system_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_db2_hive_integrated_system</span><span class="p">(</span><span class="n">subscription_name</span><span class="p">,</span><span class="n">data_warehouse_connection</span><span class="p">)</span>
            
            <span class="n">common_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_common_configuration</span><span class="p">(</span><span class="n">configuration_archive</span><span class="p">)</span>
            <span class="n">common_configuration</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">common_config</span><span class="p">,</span><span class="s1">&#39;common_configuration&#39;</span><span class="p">)</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">common_configuration</span><span class="p">,</span><span class="s2">&quot;model_type&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">model_type</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">common_configuration</span><span class="p">,</span><span class="s2">&quot;problem_type&quot;</span><span class="p">)</span>
            
            <span class="c1"># Set asset details</span>
            <span class="n">asset</span> <span class="o">=</span> <span class="n">Asset</span><span class="p">(</span>
                <span class="n">asset_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">subscription_name</span><span class="p">,</span>
                <span class="n">asset_type</span><span class="o">=</span><span class="n">AssetTypes</span><span class="o">.</span><span class="n">MODEL</span><span class="p">,</span>
                <span class="n">input_data_type</span><span class="o">=</span><span class="n">InputDataType</span><span class="o">.</span><span class="n">STRUCTURED</span><span class="p">,</span>
                <span class="n">problem_type</span><span class="o">=</span><span class="n">model_type</span>
            <span class="p">)</span>
            
            <span class="c1"># Set deployment details</span>
            <span class="n">asset_deployment</span> <span class="o">=</span> <span class="n">AssetDeploymentRequest</span><span class="p">(</span>
                <span class="n">deployment_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
                <span class="n">name</span><span class="o">=</span><span class="n">subscription_name</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;This is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subscription_name</span><span class="p">),</span>
                <span class="n">deployment_type</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span>
                <span class="n">scoring_endpoint</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">scoring</span> <span class="k">else</span> <span class="n">ScoringEndpointRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">scoring_url</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">endpoint_credentials</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">probability_field</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">model_type</span> <span class="o">!=</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">:</span>
                <span class="n">probability_field</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">common_configuration</span><span class="p">,</span><span class="s2">&quot;probability_fields&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">probability_field</span><span class="p">:</span>
                    <span class="n">probability_field</span> <span class="o">=</span> <span class="p">[</span><span class="n">get</span><span class="p">(</span><span class="n">common_configuration</span><span class="p">,</span><span class="s2">&quot;probability&quot;</span><span class="p">)]</span>

            <span class="n">asset_properties_request</span> <span class="o">=</span> <span class="n">AssetPropertiesRequest</span><span class="p">(</span>
                <span class="n">transaction_id_field</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">common_configuration</span><span class="p">,</span><span class="s2">&quot;transaction_id_field&quot;</span><span class="p">),</span>
                <span class="n">label_column</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">common_configuration</span><span class="p">,</span><span class="s2">&quot;label_column&quot;</span><span class="p">),</span>
                <span class="n">probability_fields</span><span class="o">=</span><span class="n">probability_field</span><span class="p">,</span>
                <span class="n">prediction_field</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">common_configuration</span><span class="p">,</span><span class="s2">&quot;prediction&quot;</span><span class="p">),</span>
                <span class="n">prediction_names</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">common_configuration</span><span class="p">,</span><span class="s2">&quot;prediction_names&quot;</span><span class="p">),</span>
                <span class="n">feature_fields</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">common_configuration</span><span class="p">,</span><span class="s2">&quot;feature_columns&quot;</span><span class="p">),</span>
                <span class="n">categorical_fields</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">common_configuration</span><span class="p">,</span><span class="s2">&quot;categorical_columns&quot;</span><span class="p">)</span>
            <span class="p">)</span>    
            
            <span class="n">analytics_engine</span> <span class="o">=</span> <span class="n">AnalyticsEngine</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;spark&quot;</span><span class="p">,</span>
                <span class="n">integrated_system_id</span><span class="o">=</span><span class="n">spark_engine_id</span><span class="p">,</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">spark_credentials</span><span class="p">,</span><span class="s2">&quot;spark_settings&quot;</span><span class="p">,{})</span>
            <span class="p">)</span>  
            
            <span class="n">subscription_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">data_mart_id</span><span class="o">=</span><span class="n">datamart_id</span><span class="p">,</span>
                <span class="n">service_provider_id</span><span class="o">=</span><span class="n">service_provider_id</span><span class="p">,</span>
                <span class="n">asset</span><span class="o">=</span><span class="n">asset</span><span class="p">,</span>
                <span class="n">deployment</span><span class="o">=</span><span class="n">asset_deployment</span><span class="p">,</span>
                <span class="n">asset_properties</span><span class="o">=</span><span class="n">asset_properties_request</span><span class="p">,</span>                
                <span class="n">analytics_engine</span><span class="o">=</span><span class="n">analytics_engine</span><span class="p">,</span>
                <span class="n">background_mode</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="p">)</span><span class="o">.</span><span class="n">result</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1">#Delete all the integrated systems created for this failed subscription</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creation of subscription failed&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="c1">#ids = [spark_engine_id, payload_integrated_system_id,feedback_integrated_system_id,training_integrated_system_id]</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">spark_engine_id</span><span class="p">,</span> <span class="n">db_integrated_system_id</span><span class="p">]</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">__delete_integrated_sytems</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>
        
        <span class="n">subscription_id</span> <span class="o">=</span> <span class="n">subscription_details</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">id</span>
        <span class="n">schemas_patch_document</span><span class="o">=</span><span class="p">[</span>
                <span class="n">JsonPatchOperation</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">OperationTypes</span><span class="o">.</span><span class="n">REPLACE</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/asset_properties/training_data_schema&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">common_configuration</span><span class="p">[</span><span class="s2">&quot;training_data_schema&quot;</span><span class="p">]),</span>
                <span class="n">JsonPatchOperation</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">OperationTypes</span><span class="o">.</span><span class="n">REPLACE</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/asset_properties/input_data_schema&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">common_configuration</span><span class="p">[</span><span class="s2">&quot;input_data_schema&quot;</span><span class="p">]),</span>
                <span class="n">JsonPatchOperation</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">OperationTypes</span><span class="o">.</span><span class="n">REPLACE</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/asset_properties/output_data_schema&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">common_configuration</span><span class="p">[</span><span class="s2">&quot;output_data_schema&quot;</span><span class="p">])</span>
            <span class="p">]</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">spark_engine_id</span><span class="p">,</span> <span class="n">db_integrated_system_id</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Updating schemas ...&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poll_subscription_status</span><span class="p">(</span><span class="n">subscription_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">subscription_id</span><span class="o">=</span><span class="n">subscription_id</span><span class="p">,</span> <span class="n">patch_document</span><span class="o">=</span><span class="n">schemas_patch_document</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Schemas update completed.&quot;</span><span class="p">)</span>

         <span class="c1"># Add selected tables as data sources</span>
        <span class="n">data_sources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">source_type</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">data_warehouse_connection</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload_table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">get</span><span class="p">(</span><span class="n">payload_table</span><span class="p">,</span><span class="s2">&quot;data.table&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_data_source</span><span class="p">(</span><span class="n">payload_table</span><span class="p">,</span> <span class="n">db_integrated_system_id</span><span class="p">,</span> <span class="s2">&quot;payload&quot;</span><span class="p">,</span> <span class="n">source_type</span><span class="p">))</span>
            
        <span class="k">if</span> <span class="n">feedback_table</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">feedback_table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">get</span><span class="p">(</span><span class="n">feedback_table</span><span class="p">,</span><span class="s2">&quot;data.table&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_data_source</span><span class="p">(</span><span class="n">feedback_table</span><span class="p">,</span> <span class="n">db_integrated_system_id</span><span class="p">,</span> <span class="s2">&quot;feedback&quot;</span><span class="p">,</span> <span class="n">source_type</span><span class="p">))</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Updating data-sources ...&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poll_subscription_status</span><span class="p">(</span><span class="n">subscription_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1">#patch datasources</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_sources</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data_sources_patch_document</span><span class="o">=</span><span class="p">[</span>
                 <span class="n">JsonPatchOperation</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">OperationTypes</span><span class="o">.</span><span class="n">ADD</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/data_sources&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">data_sources</span><span class="p">)</span>
            <span class="p">]</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">subscription_id</span><span class="o">=</span><span class="n">subscription_id</span><span class="p">,</span> <span class="n">patch_document</span><span class="o">=</span><span class="n">data_sources_patch_document</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data-sources update complete.&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Subscription is created. Id is : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subscription_id</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">background_mode</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Waiting for subscription to be in active state ...&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poll_subscription_status</span><span class="p">(</span><span class="n">subscription_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Subscription is now in active state.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Subscription is being activated, please wait for state to be active before using it further.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">subscription_id</span></div>


    <span class="k">def</span> <span class="nf">__create_spark_integrated_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_name</span><span class="p">,</span> <span class="n">spark_credentials</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Format of spark_credentials</span>
<span class="sd">        </span>
<span class="sd">        # Remote Spark example</span>
<span class="sd">        spark_credentials =  {</span>
<span class="sd">            &quot;connection&quot;:{</span>
<span class="sd">                &quot;endpoint&quot;: &quot;http://wimps1.fyre.ibm.com:5000&quot;,</span>
<span class="sd">                &quot;location_type&quot;: &quot;custom&quot;</span>
<span class="sd">            },</span>
<span class="sd">            &quot;credentials&quot;: {</span>
<span class="sd">                &quot;username&quot;: &quot;&lt;USERNAME&gt;&quot;,</span>
<span class="sd">                &quot;password&quot;: &quot;&lt;PASSWORD&gt;&quot;</span>
<span class="sd">            },</span>
<span class="sd">            &quot;spark_settings&quot;: {</span>
<span class="sd">                &quot;max_num_executors&quot;: 1,</span>
<span class="sd">                &quot;min_num_executors&quot;: 1,</span>
<span class="sd">                &quot;executor_cores&quot;: 1,</span>
<span class="sd">                &quot;executor_memory&quot;: 2,</span>
<span class="sd">                &quot;driver_cores&quot;: 1,</span>
<span class="sd">                &quot;driver_memory&quot;: 2</span>
<span class="sd">            }</span>
<span class="sd">        }</span>

<span class="sd">        # IAE Spark example</span>
<span class="sd">        spark_credentials = {</span>
<span class="sd">            &quot;connection&quot;: {</span>
<span class="sd">                &quot;display_name&quot;: &quot;&lt;IAE_DISPLAY_NAME&gt;&quot;,</span>
<span class="sd">                &quot;endpoint&quot;: &quot;&lt;IAE_JOB_ENDPOINT&gt;&quot;,</span>
<span class="sd">                &quot;location_type&quot;: &quot;cpd_iae&quot;,</span>
<span class="sd">                &quot;volume&quot;: &quot;&lt;VOLUME_NAME&gt;&quot;</span>
<span class="sd">            },</span>
<span class="sd">            &quot;credentials&quot;: {</span>
<span class="sd">                &quot;username&quot;: &quot;admin&quot;,</span>
<span class="sd">                &quot;apikey&quot;: &quot;&lt;APIKEY&gt;&quot;</span>
<span class="sd">            },</span>
<span class="sd">            &quot;spark_setting&quot;: {</span>
<span class="sd">                &quot;max_num_executors&quot;: 1,</span>
<span class="sd">                &quot;min_num_executors&quot;: 1,</span>
<span class="sd">                &quot;executor_cores&quot;: 1,</span>
<span class="sd">                &quot;executor_memory&quot;: 2,</span>
<span class="sd">                &quot;driver_cores&quot;: 1,</span>
<span class="sd">                &quot;driver_memory&quot;: 2</span>
<span class="sd">            }</span>
<span class="sd">        }</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">spark_engine_details</span> <span class="o">=</span> <span class="n">IntegratedSystems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">subscription_name</span> <span class="o">+</span> <span class="s2">&quot; - Spark Engine&quot;</span><span class="p">,</span>
                <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">IntegratedSystemsListEnums</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">SPARK</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">credentials</span><span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">spark_credentials</span><span class="p">,</span><span class="s2">&quot;credentials&quot;</span><span class="p">),</span>
                <span class="n">connection</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">spark_credentials</span><span class="p">,</span><span class="s2">&quot;connection&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">result</span>
            
        
        <span class="n">spark_engine_id</span> <span class="o">=</span> <span class="n">spark_engine_details</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">id</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Integrated system </span><span class="si">{}</span><span class="s2"> created &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spark_engine_id</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">spark_engine_id</span>
       
            
    <span class="k">def</span> <span class="nf">__create_db2_hive_integrated_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_name</span><span class="p">,</span> <span class="n">table_info</span><span class="p">):</span>  
        <span class="c1">#system_types = list(set([get(payload_table,&quot;type&quot;),get(feedback_table,&quot;type&quot;),get(scored_training_data_table,&quot;type&quot;)]))</span>
        <span class="c1">#if len(system_types)==1: #All are of same type</span>
        <span class="n">connection_type</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">table_info</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
        <span class="n">hive_db2_connection</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">table_info</span><span class="p">,</span><span class="s2">&quot;connection&quot;</span><span class="p">)</span>
        <span class="n">hive_db2_credentials</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">table_info</span><span class="p">,</span><span class="s2">&quot;credentials&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hive_db2_credentials</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hive_db2_credentials</span> <span class="o">=</span> <span class="p">{}</span>
            
        <span class="k">if</span> <span class="n">connection_type</span><span class="o">==</span><span class="n">IntegratedSystemsListEnums</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">HIVE</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">hive_db2_connection</span><span class="p">[</span><span class="s2">&quot;location_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;metastore&quot;</span>
        
        <span class="k">elif</span> <span class="n">connection_type</span><span class="o">==</span><span class="n">IntegratedSystemsListEnums</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">JDBC</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">hive_db2_connection</span><span class="p">[</span><span class="s2">&quot;location_type&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">IntegratedSystemsListEnums</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">JDBC</span><span class="o">.</span><span class="n">value</span>            
            <span class="n">hive_db2_credentials</span><span class="p">[</span><span class="s2">&quot;jdbc_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">table_info</span><span class="p">,</span><span class="s2">&quot;connection.jdbc_url&quot;</span><span class="p">)</span>
            
        <span class="n">hive_db2_connection_details</span> <span class="o">=</span> <span class="n">IntegratedSystems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">subscription_name</span> <span class="o">+</span> <span class="s2">&quot; - DB Info&quot;</span><span class="p">,</span>
                <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">connection_type</span><span class="p">,</span>
                <span class="n">credentials</span><span class="o">=</span><span class="n">hive_db2_credentials</span><span class="p">,</span>
                <span class="n">connection</span><span class="o">=</span><span class="n">hive_db2_connection</span>
            <span class="p">)</span><span class="o">.</span><span class="n">result</span>
        
                
        <span class="n">hive_db2_connection_id</span><span class="o">=</span><span class="n">hive_db2_connection_details</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">id</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hive/Db2 Integrated system </span><span class="si">{}</span><span class="s2"> created&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hive_db2_connection_id</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">hive_db2_connection_id</span>
    
    <span class="k">def</span> <span class="nf">__delete_integrated_sytems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cleaning up integration systems&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deleting </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
                <span class="n">IntegratedSystems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">__get_common_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration_archive</span><span class="p">):</span>
        <span class="n">common_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">configuration_archive</span><span class="p">,</span> <span class="s1">&#39;r:gz&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;common_configuration.json&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tar</span><span class="o">.</span><span class="n">getnames</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;common_configuration.json file is missing in archive file&quot;</span><span class="p">)</span>
            
            <span class="n">json_content</span> <span class="o">=</span> <span class="n">tar</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="s1">&#39;common_configuration.json&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json_content</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">common_config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  
                 
        <span class="k">return</span> <span class="n">common_config</span>    
    
    <span class="k">def</span> <span class="nf">__validate_data_warehouse_connetion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection_info</span><span class="p">):</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">connection_info</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">),</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="nb">type</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">connection_info</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="o">==</span><span class="s2">&quot;jdbc&quot;</span><span class="p">:</span>
            
            <span class="n">validate_type</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">connection_info</span><span class="p">,</span><span class="s2">&quot;connection.use_ssl&quot;</span><span class="p">),</span> <span class="s1">&#39;use_ssl&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">validate_type</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">connection_info</span><span class="p">,</span><span class="s2">&quot;connection.jdbc_driver&quot;</span><span class="p">),</span> <span class="s1">&#39;jdbc_driver&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">validate_type</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">connection_info</span><span class="p">,</span><span class="s2">&quot;connection.jdbc_url&quot;</span><span class="p">),</span> <span class="s1">&#39;jdbc_url&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            
            <span class="n">validate_type</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">connection_info</span><span class="p">,</span><span class="s2">&quot;credentials.username&quot;</span><span class="p">),</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">validate_type</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">connection_info</span><span class="p">,</span><span class="s2">&quot;credentials.password&quot;</span><span class="p">),</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
         
        <span class="k">else</span><span class="p">:</span>
            <span class="n">validate_type</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">connection_info</span><span class="p">,</span><span class="s2">&quot;connection.metastore_url&quot;</span><span class="p">),</span> <span class="s1">&#39;metastore_url&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">kerberos_enabled</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">connection_info</span><span class="p">,</span><span class="s2">&quot;connection.kerberos_enabled&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kerberos_enabled</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                 <span class="n">validate_type</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">connection_info</span><span class="p">,</span><span class="s2">&quot;connection.kerberos_enabled&quot;</span><span class="p">),</span> <span class="s1">&#39;kerberos_enabled&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                 <span class="k">if</span> <span class="n">kerberos_enabled</span><span class="p">:</span>
                     <span class="n">validate_type</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">connection_info</span><span class="p">,</span><span class="s2">&quot;credentials.kerberos_principal&quot;</span><span class="p">),</span> <span class="s1">&#39;kerberos_principal&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                     <span class="n">delegation_token_urn</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">connection_info</span><span class="p">,</span><span class="s2">&quot;credentials.delegation_token_urn&quot;</span><span class="p">)</span>
                     <span class="n">delegation_token_endpoint</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">connection_info</span><span class="p">,</span><span class="s2">&quot;credentials.delegation_token_endpoint&quot;</span><span class="p">)</span>
                     <span class="k">if</span> <span class="n">delegation_token_urn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">delegation_token_endpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Either delegation_token_urn or delegation_token_endpoint value is required when connecting to Kerberos Hive&quot;</span><span class="p">)</span>
                         
                     
    <span class="k">def</span> <span class="nf">__validate_table_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_info</span><span class="p">):</span>  
          
        <span class="n">validate_type</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">table_info</span><span class="p">,</span><span class="s2">&quot;data.auto_create&quot;</span><span class="p">),</span> <span class="s1">&#39;auto_create&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">table_info</span><span class="p">,</span><span class="s2">&quot;data.database&quot;</span><span class="p">),</span> <span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">validate_type</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">table_info</span><span class="p">,</span><span class="s2">&quot;data.table&quot;</span><span class="p">),</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__validate_response_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">schema</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;spark_schema response is empty or none&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">schema</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;struct&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The returned schema type is not struct.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;There are no fields in the returned schema.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Schema validation failed.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">__get_data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_info</span><span class="p">,</span> <span class="n">integrated_system_id</span><span class="p">,</span><span class="n">table_type</span><span class="p">,</span><span class="n">source_type</span><span class="p">):</span>
        <span class="n">auto_create</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">table_info</span><span class="p">,</span><span class="s2">&quot;data.auto_create&quot;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">table_info</span><span class="p">,</span><span class="s2">&quot;data.state&quot;</span><span class="p">,</span><span class="s2">&quot;new&quot;</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">DataSourceStatus</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;parameters&quot;</span> <span class="ow">in</span> <span class="n">table_info</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">table_info</span><span class="p">,</span><span class="s2">&quot;parameters&quot;</span><span class="p">)</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">table_type</span><span class="p">,</span> 
            <span class="n">database_name</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">table_info</span><span class="p">,</span><span class="s2">&quot;data.database&quot;</span><span class="p">),</span> 
            <span class="n">schema_name</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">table_info</span><span class="p">,</span><span class="s2">&quot;data.database&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">source_type</span><span class="o">==</span><span class="n">IntegratedSystemsListEnums</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">HIVE</span><span class="o">.</span><span class="n">value</span> <span class="k">else</span> <span class="n">get</span><span class="p">(</span><span class="n">table_info</span><span class="p">,</span><span class="s2">&quot;data.schema&quot;</span><span class="p">),</span>
            <span class="n">table_name</span><span class="o">=</span><span class="n">get</span><span class="p">(</span><span class="n">table_info</span><span class="p">,</span><span class="s2">&quot;data.table&quot;</span><span class="p">),</span> 
            <span class="n">auto_create</span> <span class="o">=</span> <span class="n">auto_create</span><span class="p">,</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">,</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">DataSourceConnection</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">source_type</span><span class="p">,</span> 
                <span class="n">integrated_system_id</span><span class="o">=</span><span class="n">integrated_system_id</span>
            <span class="p">),</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">data_source</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__create_default_monitors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscription_id</span><span class="p">,</span> <span class="n">data_mart_id</span><span class="p">,</span> <span class="n">service_provider_id</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">Target</span><span class="p">(</span>
            <span class="n">target_type</span><span class="o">=</span><span class="n">TargetTypes</span><span class="o">.</span><span class="n">SUBSCRIPTION</span><span class="p">,</span>
            <span class="n">target_id</span><span class="o">=</span><span class="n">subscription_id</span>
        <span class="p">)</span>

        <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">service_providers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">service_provider_id</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
        <span class="n">operational_space_id</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">operational_space_id</span>

        <span class="k">if</span> <span class="n">operational_space_id</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">PRODUCTION</span><span class="p">:</span>
            <span class="c1">#Create Model Health Monittor</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">monitor_definitions</span><span class="o">.</span><span class="n">MONITORS</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">MODEL_HEALTH</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__create_monitor</span><span class="p">(</span><span class="n">data_mart_id</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">monitor_definitions</span><span class="o">.</span><span class="n">MONITORS</span><span class="o">.</span><span class="n">MODEL_HEALTH</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
                
        <span class="c1"># Create performance monitor for any type of subscription    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__create_monitor</span><span class="p">(</span><span class="n">data_mart_id</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">monitor_definitions</span><span class="o">.</span><span class="n">MONITORS</span><span class="o">.</span><span class="n">PERFORMANCE</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>        

    <span class="k">def</span> <span class="nf">__create_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_mart_id</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">monitor_definition_id</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}):</span>
        <span class="n">monitor_instances_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ai_client</span><span class="o">.</span><span class="n">monitor_instances</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">monitor_definition_id</span><span class="o">=</span><span class="n">monitor_definition_id</span><span class="p">,</span>
                                <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span>
                                <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">,</span>
                                <span class="n">data_mart_id</span> <span class="o">=</span> <span class="n">data_mart_id</span><span class="p">,</span>
                                <span class="n">managed_by</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                                <span class="p">)</span>
        <span class="n">monitor_instance_id</span> <span class="o">=</span> <span class="n">monitor_instances_info</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">id</span></div>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on May 29, 2023.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>